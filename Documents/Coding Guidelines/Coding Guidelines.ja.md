# コーディングのガイドライン

## 準備

ソースファイルは、数が多い場合、シンプルな階層構造に収まっているべき。ソースファイルだけを一カ所にまとめるために "Source" のようなディレクトリーを作らない。UI などのファイルと区別できるが、それらも散らかるし、それらにもソースファイルが関連づけられる。それらはプロジェクトのルートディレクトリーに置かれなければならないことがある。

## 設計

それぞれのクラスが適度に SOLID であるべき。完璧を目指すと開発が遅れるので「適度」を考える。GitHub Copilot にそれぞれのソースファイルが SOLID かどうか聞くのも有用。

静的メソッドにより値の更新される静的プロパティーを含む静的クラスを作らない。そういったものを、ほかのクラスのインスタンスを返す get だけの静的プロパティーにする。

コレクションのプロパティーを作るときにインターフェースと通常のクラスを適切に使い分ける。モデルクラス内では、nullable かつ get/set を持つインターフェースのプロパティーが適する。通常のクラス内では、より機能性やパフォーマンスに優れる通常のクラスを nullable でない get/private-set のプロパティーとして含めるのが良い。ここでの「モデルクラス」とは、JSON との変換が行われたり、ほかのインスタンスとのデータのマッピングが行われたりのものを言う。

コードに過度のカスタマイズ性を与えない。たとえば改行は Environment.NewLine に、エンコーディングは Encoding.UTF8 にフォールバックしてよい。フォールバック先も指定できたり、環境より自動的に切り替わったりの設計は、実装するのも使うのもコストが大きい。

## 実装

できるだけ Lazy クラスを使い、必要になってから初期化されるプロパティーを多くする。起動が速くなるだけでなく、SOLID 性の向上にもつながる。

コレクションのプロパティーの名前は、それらの形式や構造でなく内容により決められるべき。通常のクラスでは大丈夫だが、ジェネリッククラスの実装においては一般的な名前にしたくて間違うことがある。そういうところでも、List より Items が良い。

変数名を適度に統一する。値型や enum なら "value"、DateTime なら "utc" や "localTime"、object やインスタンスなら "object" または "obj"、文字列なら "string" または "str"、配列なら "array"、コレクションや IEnumerable なら "items" を考える。string に "value" や "text" を使うのでは、前者ではほかの引数との衝突の可能性が高く、後者では複数形に違和感が生じる。

JSON のキー名は、アンダースコアでつながれた小文字の識別子であるべき。ユーザーによる編集の可能性のあるものなら、キーの照合は大文字・小文字の区別なく行われるべき。それだとパフォーマンスが気になるところには、そもそも JSON は適さない。

インスタンスの変換や前処理のメソッドは、null が与えられたときに null またはそれに相当するものを返すべき。たとえば文字列を行分割する場合、入力が null でも空の配列やコレクションが得られるべき。null は、「不定」や「未設定」だけを意味するものでなく、「デフォルト値にフォールバックしてほしい」を意味することもある。単純な変換や前処理においても null が積極的に排除されるのでは、プログラムの安定性が損なわれうる。ここでの「前処理」とは Trim のように「何度呼ばれてもよいもの」を言う。

IsNullOrEmpty より IsNullOrWhiteSpace を積極的に使う。たいてい最初の方で何かヒットするのでパフォーマンスの違いは微々たるもの。それでいて後者では「見える文字の含まれる、有効な文字列か」ということを確認できる。前者を使うのは、自分が実装したコード内で「null でなければ確実に値が存在する」などの条件が成立するときに限られるべき。

ユーザーの入力による文字列を積極的に trim/optimize する。Markdown は行末の空白に意味を与えるが、見えないものが意味を持つことには違和感を覚える人が自分以外にも多い。空行の連続も、役立ちうるのはスクロールさせてクイズの答えを見せるときくらいだ。さまざまな人が書き込むウェブアプリにおいては、行末の空白や余計な空行を他者への迷惑行為に使えるべきでない。

それぞれのメソッドを呼び出す側が、そのメソッド内で発生する全ての中間データにアクセスできるようにする。例としては、サーバーからの応答だったり、一時的に生成されたパスだったりが挙げられる。

全ての disposable なインスタンスが Dispose されているのを確認する。

## 品質管理

大きなクラスを partial にして、*Helper.cs ファイルにロジックをまとめることで、UI とロジックが密結合になりがちなフレームワークの利用時にもそれらを分離するべき。

スレッドセーフでないクラスやメソッドには summary のコメントをつけ、使う側が必要に応じて lock できるようにする。

ライブラリーに機能を追加するにおいては、一人で使うアプリのためのものなのか、大勢が使うシステムのためのものなのかを区別する。後者の場合、千人がその機能に同時にアクセスするとか、千のインスタンスが生成されるとかの過負荷の状態を想定してみる。

## チェック

TODO コメントがソースファイル内に残っていない。

モデルクラスの各プロパティーに、必要に応じて JsonConverter が指定されている。

出力される文字列が見えるのを確認する。null や空の文字列になりうるところに GetVisibleString を適用する。

出力されるメッセージのフォーマットが適度に統一されている。

ファイル名にアンダースコアでなくハイフンが使われている。Google が https://developers.google.com/search/docs/crawling-indexing/url-structure において言うこと。アンダースコアは URL の下線と重なることがある。
